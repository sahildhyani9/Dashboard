<!DOCTYPE html>
<html lang="en">


    <head>
        <!-- Title -->
        <title>Dashboard</title>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="x-ua-compatible" content="ie=edge">

        <!-- Favicon -->
        <link rel="shortcut icon" href="public/img/favicon.ico">
    
        <!-- Template -->
        <link rel="stylesheet" href="public/graindashboard/css/graindashboard.css">


        <!-- Chartist Core -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chartist@0.11.4/dist/chartist.min.css">
        <script src="https://cdn.jsdelivr.net/npm/chartist@0.11.4/dist/chartist.min.js"></script>

        <!-- Chartist Tooltip Plugin -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chartist-plugin-tooltips@0.0.17/dist/chartist-plugin-tooltip.css">
        <script src="https://cdn.jsdelivr.net/npm/chartist-plugin-tooltips@0.0.17/dist/chartist-plugin-tooltip.min.js"></script>


        <!-- PapaParse -->
        <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    </head>

    <body class="has-sidebar has-fixed-sidebar-and-header">
        <!-- Header -->
        <header class="header bg-body">
            <nav class="navbar flex-nowrap p-0">
                <div class="container-fluid">
                    <!-- Filters -->
                    <div class="dropdown ml-auto">                   
                        <div class="filters">
                            <label>Year:</label>
                            <select id="yearFilter">
                            <option value="2025-2026">2025-2026</option>
                            <option value="2024-2025">2024-2025</option>
                            <option value="2023-2024">2023-2024</option>
                            <option value="2022-2023">2022-2023</option>
                            <option value="2021-2022">2021-2022</option>
                            </select>                            
                        </div>
                    </div>
                    <!-- End Filters -->                                
                </div>
            </nav>
            <style>
                .filters {
                display: flex;
                align-items: center;
                gap: 16px;
                background-color: #f8f9fa;
                padding: 12px 20px;
                border-radius: 6px;
                font-size: 16px;
                }

                .filters label {
                margin-bottom: 0;
                font-weight: 600;
                color: #333;
                font-size: 16px;
                }

                .filters select {
                height: 40px;
                padding: 8px 12px;
                border: 1px solid #ccc;
                border-radius: 6px;
                outline: none;
                font-size: 16px;
                min-width: 140px;
                background-color: #fff;
                }

                .filters select:focus {
                border-color: #007bff;
                box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
                }
            </style>
        </header>
        <!-- End Header -->

        <main class="main px-0">
            <div class="container-fluid px-0">
                <div class="row no-gutters">     
                    <!-- Sidebar Nav -->
                    <div class="col-12 col-md-3 col-xl-2 mb-3 mb-md-0 pl-0">
                        <ul id="sideNav" class="side-nav-menu side-nav-menu-top-level mb-0">
                            <!-- Title -->
                            <li class="sidebar-heading h6">Dashboard</li>

                            <!-- Navigation Items -->
                            <li class="side-nav-menu-item active">
                                <a class="side-nav-menu-link media align-items-center" href="index.html">
                                    <span class="side-nav-menu-icon d-flex mr-3">
                                        <i class="gd-dashboard"></i>
                                    </span>
                                    <span class="side-nav-fadeout-on-closed media-body">Sahil</span>                        
                                </a>
                                <a class="side-nav-menu-link media align-items-center" href="pavi.html">
                                    <span class="side-nav-menu-icon d-flex mr-3">
                                        <i class="gd-dashboard"></i>
                                    </span>
                                    <span class="side-nav-fadeout-on-closed media-body">Pavi</span>                        
                                </a>
                                <a class="side-nav-menu-link media align-items-center" href="compiled.html">
                                    <span class="side-nav-menu-icon d-flex mr-3">
                                        <i class="gd-dashboard"></i>
                                    </span>
                                    <span class="side-nav-fadeout-on-closed media-body">Compiled</span>                        
                                </a>
                                <a class="side-nav-menu-link media align-items-center" href="share.html">
                                    <span class="side-nav-menu-icon d-flex mr-3">
                                        <i class="gd-dashboard"></i>
                                    </span>
                                    <span class="side-nav-fadeout-on-closed media-body">Shares</span>                        
                                </a>
                                <a class="side-nav-menu-link media align-items-center" href="investments.html">
                                    <span class="side-nav-menu-icon d-flex mr-3">
                                        <i class="gd-dashboard"></i>
                                    </span>
                                    <span class="side-nav-fadeout-on-closed media-body">Investments</span>                        
                                </a>                                
                            </li>
                        </ul>

                        <style>
                         .side-nav-menu {
                            position: sticky;      /* Sticks to the top of the viewport */
                            top: 0;                /* Position from top */
                            max-height: 100vh;     /* Fill screen height */
                            overflow-y: auto;      /* Add vertical scroll when content overflows */
                            padding-right: 5px;
                            }
                        </style>
                    </div>                
                    <!-- End Sidebar Nav -->

                    <div class="content">
                        <div class="py-4 px-3 px-md-4">
                            <div class="mb-3 mb-md-4 d-flex justify-content-between">
                                <div class="h3 mb-0">Dashboards</div>
                            </div>
                                                    
                            <!-- Summary Tab Section -->
                            <div class="row">
                                <div class="col-md-4 mb-3 mb-xl-4">
                                    <div class="card flex-row align-items-center p-3 p-md-4">
                                        <div class="icon icon-lg bg-soft-primary rounded-circle mr-3">
                                            <i class="gd-bar-chart icon-text d-inline-block text-primary"></i>
                                        </div>
                                        <div>
                                            <h4 class="lh-1 mb-1" id="summary-invested">₹0.00</h4>
                                            <h6 class="mb-0">Total Investments</h6>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3 mb-xl-4">
                                    <div class="card flex-row align-items-center p-3 p-md-4">
                                        <div class="icon icon-lg bg-soft-secondary rounded-circle mr-3">
                                            <i class="gd-wallet icon-text d-inline-block text-secondary"></i>
                                        </div>
                                        <div>
                                            <h4 class="lh-1 mb-1" id="summary-corpus">₹0.00</h4>
                                            <h6 class="mb-0">Total Corpus</h6>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3 mb-xl-4">
                                    <div class="card flex-row align-items-center p-3 p-md-4">
                                        <div class="icon icon-lg bg-soft-success rounded-circle mr-3">
                                            <i class="gd-money icon-text d-inline-block text-success"></i>
                                        </div>
                                        <div>
                                            <h4 class="lh-1 mb-1" id="summary-profit">0.00%</h4>
                                            <h6 class="mb-0">Net Profit (%)</h6>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Mutual Funds Only Summary Section -->
                            <div class="row mt-3">
                                <div class="col-md-4 mb-3 mb-xl-4">
                                    <div class="card flex-row align-items-center p-3 p-md-4">
                                        <div class="icon icon-lg bg-soft-primary rounded-circle mr-3">
                                            <i class="gd-bar-chart icon-text d-inline-block text-primary"></i>
                                        </div>
                                        <div>
                                            <h4 class="lh-1 mb-1" id="mf-summary-invested">₹0.00</h4>
                                            <h6 class="mb-0">MF Total Investments</h6>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3 mb-xl-4">
                                    <div class="card flex-row align-items-center p-3 p-md-4">
                                        <div class="icon icon-lg bg-soft-secondary rounded-circle mr-3">
                                            <i class="gd-wallet icon-text d-inline-block text-secondary"></i>
                                        </div>
                                        <div>
                                            <h4 class="lh-1 mb-1" id="mf-summary-corpus">₹0.00</h4>
                                            <h6 class="mb-0">MF Total Corpus</h6>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3 mb-xl-4">
                                    <div class="card flex-row align-items-center p-3 p-md-4">
                                        <div class="icon icon-lg bg-soft-success rounded-circle mr-3">
                                            <i class="gd-money icon-text d-inline-block text-success"></i>
                                        </div>
                                        <div>
                                            <h4 class="lh-1 mb-1" id="mf-summary-profit">0.00%</h4>
                                            <h6 class="mb-0">MF Net Profit (%)</h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Mutual Funds Tab Section -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card mb-3 mb-md-4">
                                        <div class="card-header border-bottom p-0">
                                            <ul id="mfTabs1" class="nav nav-v2 nav-primary nav-justified d-block d-xl-flex w-100" role="tablist">
                                            <!-- Dynamic Tabs injected here -->
                                            </ul>
                                        </div>
                                        <div id="mfContent1" class="card-body tab-content"><!-- Dynamic Tab Content injected here --></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Second Mutual Funds Tab Section -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card mb-3 mb-md-4">
                                        <div class="card-header border-bottom p-0">
                                            <ul id="mfTabs2" class="nav nav-v2 nav-primary nav-justified d-block d-xl-flex w-100" role="tablist"></ul>
                                        </div>
                                        <div id="mfContent2" class="card-body tab-content"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Third Mutual Funds Tab Section -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card mb-3 mb-md-4">
                                        <div class="card-header border-bottom p-0">
                                            <ul id="mfTabs3" class="nav nav-v2 nav-primary nav-justified d-block d-xl-flex w-100" role="tablist"></ul>
                                        </div>
                                        <div id="mfContent3" class="card-body tab-content"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- jQuery (required for Bootstrap tabs) -->
                            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

                            <!-- Bootstrap JS (required for tab switching) -->
                            <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script> 

                    
                            <script>
                                const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrmX-VEuiywJZwt1Ylfoit1kdHtEhsVz13DeoVFX_X8JIXY8cMUAeVawKW5ulVTq40QMFxZVOS2Ui7/pub?gid=1928756849&single=true&output=csv";

                                // Define your two sets of funds
                                const allowedFunds1 = [
                                "MF 2 - Axis Focused",
                                "MF 3 - Canara Robeco S",
                                "MF 4 - Axis Bluechip S",
                                "MF 5 - Nippon"
                                ];
                                const allowedFunds2 = [
                                "MF 6 - SBI",
                                "PPF",
                                "ELSS",
                                "NPS"                        
                                ];
                                const allowedFunds3 = [
                                "Shares"                                               
                                ];

                                function slugify(text) {
                                return text.toLowerCase().replace(/[^a-z0-9]+/g, "-");
                                }

                                function renderTab(name, index, tabsId) 
                                {
                                    const tabId = slugify(name) + "-" + tabsId;
                                    const activeClass = index === 0 ? 'active' : '';
                                    const tabHTML = `
                                    <li class="nav-item border-bottom border-xl-bottom-0 ${index !== 0 ? 'border-xl-left' : ''}">
                                        <a class="nav-link d-flex align-items-center py-2 px-3 p-xl-4 ${activeClass}" href="#${tabId}" role="tab" data-toggle="tab">
                                            <span>${name}</span>
                                            <small id="${tabId}-total" class="text-muted ml-auto">Loading...</small>
                                        </a>
                                    </li>`;
                                    document.getElementById(tabsId).insertAdjacentHTML("beforeend", tabHTML);
                                }

                                function renderTabContent(name, index, contentId, tabsId) 
                                {
                                    const tabId = slugify(name) + "-" + tabsId;
                                    const activeClass = index === 0 ? "show active" : "";
                                    const tabContentHTML = `
                                        <div class="tab-pane fade ${activeClass}" id="${tabId}" role="tabpanel">
                                        <div class="row text-center">
                                            <div class="col-6 col-md-4 mb-3 mb-md-0">
                                            <div class="h3 mb-0" id="${tabId}-invested">₹0.00</div>
                                            <small class="text-muted">Total Investment</small>
                                            </div>
                                            <div class="col-6 col-md-4 mb-3 mb-md-0 border-left">
                                            <div class="h3 mb-0" id="${tabId}-corpus">₹0.00</div>
                                            <small class="text-muted">Total Corpus</small>
                                            </div>
                                            <div class="col-12 col-md-4 border-left">
                                            <div class="h3 mb-0" id="${tabId}-profit">0.00%</div>
                                            <small class="text-muted">Net Profit (%)</small>
                                            </div>
                                        </div>
                                        <div id="${tabId}-chart" class="ct-chart position-relative mt-4" style="height: 250px;"></div>
                                        </div>`;
                                    document.getElementById(contentId).insertAdjacentHTML("beforeend", tabContentHTML);
                                }

                                function renderChart(tabId, labels, values) 
                                {
                                    new Chartist.Line(`#${tabId}-chart`, {
                                        labels,
                                        series: [values]
                                    }, {
                                        low: 0,
                                        showArea: true,
                                        fullWidth: true,
                                        chartPadding: { right: 20 },
                                        lineSmooth: Chartist.Interpolation.simple(),
                                        axisX: { showGrid: false },
                                        axisY: { onlyInteger: true },
                                        plugins: [Chartist.plugins.tooltip()]
                                    });
                                }

                                function initDashboard(data, selectedYear, allowedFunds, tabsId, contentId) 
                                {
                                    const tabsContainer = document.getElementById(tabsId);
                                    const contentContainer = document.getElementById(contentId);
                                    tabsContainer.innerHTML = "";
                                    contentContainer.innerHTML = "";

                                    const filtered = data.filter(row => {
                                        return allowedFunds.includes(row["Type"]?.trim()) && row["Year"]?.trim() === selectedYear;
                                    });

                                    filtered.forEach((row, index) => {
                                        const fund = row["Type"].trim();
                                        const tabId = slugify(fund) + "-" + tabsId;
                                        const investment = parseFloat((row["Investment"] || "0").replace(/,/g, "")) || 0;
                                        const corpus = parseFloat((row["Return"] || "0").replace(/,/g, "")) || 0;
                                        if (!investment && !corpus) return;

                                        renderTab(fund, index, tabsId);
                                        renderTabContent(fund, index, contentId, tabsId);

                                        const profit = investment ? ((corpus - investment) / investment) * 100 : 0;

                                        document.getElementById(`${tabId}-total`).textContent = `₹${investment.toFixed(2)}`;
                                        document.getElementById(`${tabId}-invested`).textContent = `₹${investment.toFixed(2)}`;
                                        document.getElementById(`${tabId}-corpus`).textContent = `₹${corpus.toFixed(2)}`;
                                        document.getElementById(`${tabId}-profit`).textContent = `${profit.toFixed(2)}%`;

                                        const labels = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul"];
                                        const values = labels.map((_, i) => investment + ((corpus - investment) * i / (labels.length - 1)));

                                        // Always render chart when tab is shown
                                        $(`a[href="#${tabId}"]`).on("shown.bs.tab", () => {
                                    document.getElementById(`${tabId}-chart`).innerHTML = "";
                                    setTimeout(() => renderChart(tabId, labels, values), 10);
                                    });

                                        // Render chart for the first tab immediately
                                        if (index === 0) {
                                        setTimeout(() => {
                                            renderChart(tabId, labels, values);
                                        }, 0);
                                        }
                                    });
                                }

                                function renderSummary(data, selectedYear) 
                                {
                                    // Filter for the selected year
                                    const filtered = data.filter(row => row["Year"]?.trim() === selectedYear);

                                    let totalInvestment = 0;
                                    let totalCorpus = 0;

                                    filtered.forEach(row => {
                                        totalInvestment += parseFloat((row["Investment"] || "0").replace(/,/g, "")) || 0;
                                        totalCorpus += parseFloat((row["Return"] || "0").replace(/,/g, "")) || 0;
                                    });

                                    const profit = totalInvestment ? ((totalCorpus - totalInvestment) / totalInvestment) * 100 : 0;

                                    document.getElementById("summary-invested").textContent = `₹${totalInvestment.toFixed(2)}`;
                                    document.getElementById("summary-corpus").textContent = `₹${totalCorpus.toFixed(2)}`;
                                    document.getElementById("summary-profit").textContent = `${profit.toFixed(2)}%`;
                                }
                                            
                                function renderMfSummary(data, selectedYear) 
                                {
                                    const mutualFunds = [
                                    "MF 2 - Axis Focused",
                                    "MF 3 - Canara Robeco S",
                                    "MF 4 - Axis Bluechip S",
                                    "MF 5 - Nippon",
                                    "MF 6 - SBI"
                                    ];

                                    const filtered = data.filter(row => 
                                    row["Year"]?.trim() === selectedYear && mutualFunds.includes(row["Type"]?.trim())
                                    );

                                    let totalInvestment = 0;
                                    let totalCorpus = 0;

                                    filtered.forEach(row => {
                                        totalInvestment += parseFloat((row["Investment"] || "0").replace(/,/g, "")) || 0;
                                        totalCorpus += parseFloat((row["Return"] || "0").replace(/,/g, "")) || 0;
                                    });

                                    const profit = totalInvestment ? ((totalCorpus - totalInvestment) / totalInvestment) * 100 : 0;

                                    document.getElementById("mf-summary-invested").textContent = `₹${totalInvestment.toFixed(2)}`;
                                    document.getElementById("mf-summary-corpus").textContent = `₹${totalCorpus.toFixed(2)}`;
                                    document.getElementById("mf-summary-profit").textContent = `${profit.toFixed(2)}%`;
                                }
                                                            
                                // Call renderSummary after dashboards are initialized
                                function updateAllDashboardsAndSummary(data, selectedYear) 
                                {
                                    initDashboard(data, selectedYear, allowedFunds1, "mfTabs1", "mfContent1");
                                    initDashboard(data, selectedYear, allowedFunds2, "mfTabs2", "mfContent2");
                                    initDashboard(data, selectedYear, allowedFunds3, "mfTabs3", "mfContent3");
                                    renderSummary(data, selectedYear);
                                    renderMfSummary(data, selectedYear);
                                }

                                // Update your Papa.parse and yearFilter event:
                                Papa.parse
                                (csvUrl, {
                                    download: true,
                                    header: true,
                                    complete: function(results) {
                                        rawData = results.data;
                                        const defaultYear = document.getElementById("yearFilter").value;
                                        updateAllDashboardsAndSummary(rawData, defaultYear);
                                    }
                                });

                                document.getElementById("yearFilter").addEventListener("change", function() {
                                const selectedYear = this.value;
                                updateAllDashboardsAndSummary(rawData, selectedYear);
                                });

                            </script>  
                
                        </div>
                    </div>
                </div>    
            </div>
        </main>
    </body>

</html>